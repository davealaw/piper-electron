<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>Piper TTS GUI</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    label {
      font-weight: bold;
    }
    input, textarea, select {
      width: 100%;
      margin: 10px 0;
      padding: 6px;
      font-size: 1em;
    }
    button {
      padding: 10px 20px;
      font-size: 1em;
      margin-top: 10px;
    }
    #status {
      margin-top: 10px;
      color: #444;
    }
    .inline-group {
      display: flex;
      gap: 10px;
      align-items: center;
    }
    .inline-group input[type="text"] {
      flex-grow: 1;
    }
    #spinner {
      display: none;
      margin-top: 10px;
    }

    .spinner-dot {
      display: inline-block;
      width: 8px;
      height: 8px;
      margin-right: 4px;
      border-radius: 50%;
      background-color: #444;
      animation: blink 1s infinite alternate;
    }

    .spinner-dot:nth-child(2) { animation-delay: 0.2s; }
    .spinner-dot:nth-child(3) { animation-delay: 0.4s; }

    @keyframes blink {
      0% { opacity: 0.2; }
      100% { opacity: 1; }
    }
  </style>
</head>
<body>
  <h2>Piper TTS</h2>

  <label for="modelSelect">Choose Voice Model:</label>
  <select id="modelSelect">
    <option disabled selected>Loading models...</option>
  </select>

  <label for="ttsText">Text to Speak:</label>
  <textarea id="ttsText" rows="5" placeholder="Enter text here..."></textarea>

  <label for="outputPath">Output File (optional):</label>
  <div class="inline-group">
    <input id="outputPath" type="text" readonly placeholder="out.wav (default)" />
    <button onclick="chooseOutput()">Browse...</button>
  </div>

  <button id="speakButton" onclick="speakText()">Speak</button>
  <button onclick="resetToDefaults()" style="margin-left: 10px; background-color: #f44; color: white;">Reset to Defaults</button>

  <p id="status"></p>
  
  <div id="progressContainer" style="display: none; margin-top: 10px;">
    <div style="width: 100%; background: #ccc; border-radius: 4px;">
      <div id="progressBar" style="width: 0%; height: 12px; background: #4caf50; border-radius: 4px;"></div>
    </div>
    <p id="progressText" style="margin: 4px 0 0; font-size: 0.9em;">0%</p>
  </div>

<script>
  let outputFilePath = null;

  async function populateVoices() {
    const voices = await window.piperAPI.getVoiceModels();
    const select = document.getElementById('modelSelect');
    const textArea = document.getElementById('ttsText');

    if (!voices.length) {
      select.innerHTML = `<option disabled selected>No valid models found</option>`;
      return;
    }

    // Populate model list
    select.innerHTML = voices.map(path =>
      `<option value="${path}">${path.split('/').pop()}</option>`
    ).join('');

    // Get saved settings
    const settings = await window.piperAPI.getLastSettings();

    if (settings.lastModel && voices.includes(settings.lastModel)) {
      select.value = settings.lastModel;
    }

    if (settings.lastOutput) {
      outputFilePath = settings.lastOutput;
      document.getElementById('outputPath').value = outputFilePath;
    }

    if (settings.lastText) {
      textArea.value = settings.lastText;
    }
  }

  async function chooseOutput() {
    const selected = await window.piperAPI.chooseOutputFile();
    if (selected) {
      outputFilePath = selected;
      document.getElementById('outputPath').value = outputFilePath;
    }
  }

  async function speakText() {
    const text = document.getElementById('ttsText').value;
    const modelPath = document.getElementById('modelSelect').value;
    const status = document.getElementById('status');
    const speakBtn = document.getElementById('speakButton');
    const progressContainer = document.getElementById('progressContainer');
    const progressBar = document.getElementById('progressBar');
    const progressText = document.getElementById('progressText');

    speakBtn.disabled = true;
    status.textContent = 'Processing...';
    progressContainer.style.display = 'block';
    progressBar.style.width = '0%';
    progressText.textContent = '0%';

    // Estimate duration based on text length
    const charsPerSecond = 15; // tweak this if needed
    const estimatedDuration = (text.length / charsPerSecond) * 1000;
    const startTime = Date.now();

    // Progress animation loop
    let progressTimer = setInterval(() => {
      const elapsed = Date.now() - startTime;
      let percent = Math.min(90, Math.floor((elapsed / estimatedDuration) * 100));

      progressBar.style.width = percent + '%';
      progressText.textContent = percent + '%';
    }, 100);

    try {
      await window.piperAPI.speak(text, modelPath, outputFilePath);
      progressBar.style.width = '100%';
      progressText.textContent = '100%';
      status.textContent = 'Done!';
    } catch (err) {
      status.textContent = 'Error: ' + err;
    } finally {
      clearInterval(progressTimer);
      speakBtn.disabled = false;

      setTimeout(() => {
        progressContainer.style.display = 'none';
        progressBar.style.width = '0%';
        progressText.textContent = '';
      }, 1000);
    }
  }

  async function resetToDefaults() {
    const confirmed = confirm('Are you sure you want to reset all settings to defaults?');
    if (!confirmed) return;

    await window.piperAPI.resetSettings();
    location.reload(); // reloads the app with default state
  }

  // Call on load
  window.onload = populateVoices;
</script>

</body>
</html>
